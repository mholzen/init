#!/bin/bash

dir="${@:-.}"
if [ -d "$dir" ]; then
  dir=$(cd "$dir"; pwd)
fi

dufile=~/.du
test -r $dufile || touch $dufile

function update {
  {
    grep -v "$dir" $dufile;
    ( cd / ; du -k "$dir" );
  } | sort -rn | tee $dufile
}

function view {
  grep -i --no-filename "$dir" "$dufile"
}

function human {
  awk '
    function human(x) {
        if (x<1000) {return x} else {x/=1024}
        s="MGTEPYZ";
        while (x>=1000 && length(s)>1)
            {x/=1024; s=substr(s,2)}
        return int(x+0.5) substr(s,1,1)
    }
    {sub(/^[0-9]+/, human($1)); print}'
}

cmd=$(basename $0)
cmd=${cmd/du-/}

eval $cmd | human | less
